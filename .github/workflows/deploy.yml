name: CI/CD - main & dev

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SRV_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SRV_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SRV_USER_NAME }}@${{ secrets.SRV_HOST }} '
          set -e
          BRANCH="main"
          DIR="/opt/insomnia-app/chat"
          REPO="https://github.com/${{ github.repository }}"

          mkdir -p "$DIR"
          cd "$DIR"

          if [ ! -d "$DIR/.git" ]; then
            git clone -b "$BRANCH" "$REPO" "$DIR"
            cd "$DIR"
          else
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          fi

          cat > .env <<EOF
SYNAPSE_REGISTRATION_SHARED_SECRET=${{ secrets.SYNAPSE_REGISTRATION_SHARED_SECRET }}
POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
MACAROON_SECRET_KEY=${{ secrets.MACAROON_SECRET_KEY }}
FORM_SECRET=${{ secrets.FORM_SECRET }}
LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
EOF

          chmod 600 .env

          docker compose down || true
          docker compose build
          docker compose up -d
        '

