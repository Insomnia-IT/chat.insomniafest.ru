worker_processes  1;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    upstream element_web {
        server matrix_element:80;
    }

    upstream synapse {
        server matrix_synapse:8008;
    }

    # 1) Front door: chat.insomniafest.ru
    server {
        listen 80;
        server_name chat.insomniafest.ru;

        root /usr/share/nginx/html;
        index index.html;

        location = /.well-known/matrix/client {
            default_type application/json;
            return 200 '{"m.homeserver":{"base_url":"https://synapse-chat.insomniafest.ru"}}';
        }

        # static landing page and downloads are served directly from /usr/share/nginx/html
    }

    # 2) Element Web: web-chat.insomniafest.ru
    server {
        listen 80;
        server_name web-chat.insomniafest.ru;

        location / {
            proxy_pass http://element_web/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $remote_addr;
        }
    }

    # 3) Synapse API: synapse-chat.insomniafest.ru
    server {
        listen 80;
        server_name synapse-chat.insomniafest.ru;

        location ^~ /_matrix/ {
            proxy_pass http://synapse;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ^~ /_synapse/ {
            proxy_pass http://synapse;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location = /.well-known/matrix/client {
            default_type application/json;
            return 200 '{"m.homeserver":{"base_url":"https://synapse-chat.insomniafest.ru"}}';
        }

        location / {
            return 200 "Synapse API endpoint\n";
        }
    }
}
